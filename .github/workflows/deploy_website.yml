name: Deploy Static Website

on:
  # Manual trigger using GitHub Actions UI
  workflow_dispatch:
    inputs:
      domain_name:
        description: 'Domain name for the website'
        required: false
        default: 'greateightgoals.com'
        type: string
      stack_name:
        description: 'CloudFormation stack name for the static website'
        required: false
        default: 'static-website'
        type: string
      force_bucket_recreation:
        description: 'Force recreation of S3 bucket'
        required: false
        default: false
        type: boolean
      region:
        description: 'AWS region'
        required: false
        default: 'us-east-1'
        type: string
      environment:
        description: 'Environment (dev/prod) - for reference only'
        required: false
        default: 'prod'
        type: choice
        options:
          - dev
          - prod
      command:
        description: 'Command to run (deploy, update-green, etc.)'
        required: false
        default: 'deploy'
        type: string
      additional_args:
        description: 'Additional arguments to pass to the command'
        required: false
        type: string
      skip_content_upload:
        description: 'Skip uploading content to S3 bucket'
        required: false
        default: false
        type: boolean
      skip_dns_record:
        description: 'Skip creating/updating Route 53 DNS record'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # Required for OIDC authentication
      contents: read    # Required to checkout the repository

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          # Don't use pip cache to avoid the cache folder error

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ inputs.region || 'us-east-1' }}

      - name: Run command
        run: |
          # Make the script executable
          chmod +x ./aws-static-website/run.sh
          
          # Build the command with dynamic inputs
          CMD="./aws-static-website/run.sh ${{ inputs.command || 'deploy' }}"
          
          # Add domain name if specified
          if [[ -n "${{ inputs.domain_name }}" ]]; then
            CMD="$CMD --domain-name ${{ inputs.domain_name }}"
          fi
          
          # Add stack name if specified
          if [[ -n "${{ inputs.stack_name }}" ]]; then
            CMD="$CMD --stack-name ${{ inputs.stack_name }}"
          fi
          
          # Add force bucket recreation if true
          if [[ "${{ inputs.force_bucket_recreation }}" == "true" ]]; then
            CMD="$CMD --force-bucket-recreation"
          fi
          
          # Add skip content upload if true
          if [[ "${{ inputs.skip_content_upload }}" == "true" ]]; then
            CMD="$CMD --skip-content-upload"
          fi
          
          # Add skip DNS record if true
          if [[ "${{ inputs.skip_dns_record }}" == "true" ]]; then
            CMD="$CMD --skip-dns-record"
          fi
          
          # Add any additional arguments
          if [[ -n "${{ inputs.additional_args }}" ]]; then
            CMD="$CMD ${{ inputs.additional_args }}"
          fi
          
          # Execute the command
          echo "Executing: $CMD"
          eval "$CMD"
          
      - name: Verify deployment
        run: |
          # Check if the CloudFormation stack exists
          echo "Verifying CloudFormation stack ${{ inputs.stack_name || 'static-website' }}..."
          aws cloudformation describe-stacks \
            --stack-name ${{ inputs.stack_name || 'static-website' }} \
            --region ${{ inputs.region || 'us-east-1' }} \
            --query "Stacks[0].{Name:StackName, Status:StackStatus, Outputs:Outputs}" \
            --output table
          
          # If the stack has outputs, try to get the CloudFront distribution ID
          CF_DIST_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ inputs.stack_name || 'static-website' }} \
            --region ${{ inputs.region || 'us-east-1' }} \
            --query "Stacks[0].Outputs[?OutputKey=='CloudFrontDistributionId'].OutputValue" \
            --output text)
          
          if [[ -n "$CF_DIST_ID" ]]; then
            echo "CloudFront Distribution ID: $CF_DIST_ID"
            
            # Get CloudFront distribution details
            aws cloudfront get-distribution \
              --id "$CF_DIST_ID" \
              --query "Distribution.{Id:Id, DomainName:DomainName, Status:Status, Enabled:DistributionConfig.Enabled, Origins:DistributionConfig.Origins.Items[].DomainName}" \
              --output table
          fi
